---
title: "Analysis of Cerebrospinal Fluid Dynamics - II. LBM"
tags:
  - hpc
  - dns
  - lbm
  - csf
---

Cerebrospinal fluid ([CSF][csfwiki]) dynamics in the human central nerve system
(CNS) is an extremely interesting topic in bio-fluid mechanics.
The disorders of the CNS components disrupt the CSF pulsatility
which is involved in a number of vital functions. The CFD analysis can
be used to quantify the functional interactions of the CNS member. The
numerical simulations of CSF filled in brain ventricles and
[subarachnoid spaces][saswiki] (SAS) are performed to build up a basis for
testing and optimizing the CNS therapeutics via understanding of the
CSF pathophysiology. In this post a recent collaboration of the
[SimLab - Highly Scalable Fluids and Solids Engineering](https://www.jara.org/de/forschung/center-for-simulation-and-data-sciences/simulation-laboratories/highly-scalable-fluids-and-solids-engineering "SLFSE at JSC")
at the [J&uuml;lich Supercomputing Centre][jsc-link]
with [Korea University Medical Center][kumc-link] is presented.

## Numerical Methods and Algorithms

In this project, several software components will be utilized to
develop HPC- and CFD services for the medical community. That is, for
CFD computations the modular framework ZFS, which is primarily
developed at AIA, will be used. Interactive supercomputing, i.e.,
black-boxed access to HPC resources and simulation results will be
provided by an intuitive [Jupyter Hub environment][jupyterhub]. Virtual surgeries 
and hence in-situ computational steering will be implemented by
interfacing ZFS with a web-based application to modify the anatomical
shape. In the context of ML, the package
[Tensorflow][tensorflow] will be
employed. Since the lattice-Boltzmann method in ZFS will consume most
of the computational resources, the following discussion concentrates
on the explanation of the involved numerical algorithms.

ZFS consists of a parallel Cartesian grid generator and several solver
modules to account for different physics. The code is written in C++,
hybrid MPI/OpenMP parallelized and has in parts been ported to
GPGPUs ([Kraus et al. 2014][Kraus2014], [Nicolini et al. 2016][Nicolini2016]) and Intel Xeon Phi Knights
Landing platforms. Parallel I/O makes use of 
HPC I/O libraries ([Li et al. 2003][LiZingaleEtAl03], [Folk & Pourmal 2010][Folk2010]) .

The computational domain is discretized by a hierarchical Cartesian
octree mesh, which is generated by the method described
in [Lintermann et al. 2014][LintermannSchlimpertEtAl14]. Initially, a single
cubic cell containing the whole computational domain is generated 
on every process, which is uniformly refined up to a level
$l_\alpha$ by isotropic subdivision into eight cubic child
cells. Cells outside the geometry are removed from the tree. On level 
$l_\alpha$ all cells on $l<l_\alpha$ are deleted. A Hilbert
space-filling curve [Sagan 1994][Sagan94] decomposes the remaining cells on
the number of processors. In parallel, each process 
continues to refine the mesh uniformly up to level
$l_\beta$. Individual regions of the mesh are further refined to
level $l_\gamma$ to meet resolution requirements. The algorithm
ensures neighboring cells 
on different levels to have a level difference of maximum 1. Uneven
work-load distributions are accounted for by a load-balancing
method. The mesh is the written to disk in parallel. A
list, consisting in principle of the cells on level $l_\alpha$, is used
in the simulation to optimally subdivide the
problem on the computational cores. Note that the number of
processes employed for the simulation can be different from that of
the grid generation. Furthermore, the geometry can
be parallelized using the approach from [Lintermann 2016][Lintermann2016]. For
more information, the reader is referred
to [Lintermann et al. 2014][LintermannSchlimpertEtAl14], [Lintermann 2016][Lintermann2016].

The LBM has been shown to be well-suited for the simulation
of respiratory flows in the low _Mach_ number and low to
moderate _Reynolds_ number regime ([Freitas et al. 2008][FreitasSchroeder08],
[Lintermann & Schr&ouml;der 2017][Lintermann2017a]).
It solves the lattice-Bhatnagar-Gross-Krook (LBGK) equation ([Bhatnagar et al. 1954][Bhatnagar1954],
[H&auml;nel 2004][Hanel2004])
for the particle probability distribution functions $f_i$ (PPDFs) for a direction $i$. 

![D3Q27](https://ars.els-cdn.com/content/image/1-s2.0-S0898122115000346-gr1.jpg "Spatial discretization with the D3Q27 scheme")

The PPDF $f_i$ with $i=27$ corresponds to the rest particle distribution.
The D3Q15 and D3Q19 models are subsets of the D3Q27 model.

\begin{equation}
  f_i\left(\mathbf{x}+\mathbf{\Xi}_i\delta t,t+\delta t\right) = f_i\left(\mathbf{x},t\right) + \omega_F\delta t\cdot\left(f_i^{eq}\left(\mathbf{x},t\right)-f_i\left(\mathbf{x},t\right)\right).
\end{equation}

In this equation, $\mathbf{\Xi}_i$ represents the discrete velocity vector,
$\mathbf{x}$ is the spatial location, $f_i^{eq}$ is the Maxwellian
equilibrium distribution function, $\omega_F$ is the particle
collision frequency, $t$ is the time, and $\delta t$ is the time
increment. The collision frequency is determined by

\begin{equation}
  \omega_F = \frac{c_s^2}{\nu+\delta t c_s^2/2}
\end{equation}

with the speed of sound $c_s$ and the kinematic viscosity $\nu$ of the
fluid. The Maxwellian equilibrium function is given by

\begin{equation}
  f_i^{eq}(r,t)=\rho \underbrace{t_p \bigg[1+\frac{v_a\xi_{i,a}}{c_s^2}+\frac{v_a v_b}{2c_s^2}\cdot\left(\frac{\xi_{i,a}\xi_{i,b}}{c_s^2}-\delta_{ab}\right)\bigg]}_{\chi},
\end{equation}

where $t_p$ is a direction dependent weight factor, $\rho$ and
$v_{a,b}$ are the fluid density and velocities, and $\delta_{ab}$ is
the Kronecker delta with $a,b\in\{1,2,3\}$.
The most frequently applied discretization models to solve the LBGK
equation in three dimensions are the D3Q19 and D3Q27 models ([Qian et al. 1992][Qian1992]) with 19 and
27 discrete PPDF directions, respectively. Since former
model is rotational not invariant ([White & Chong 2011][White2011], [Kuwata & Suga 2015][Kuwata2015]),
the D3Q27 model is preferred for the computations in this project.
The [figure](https://ars.els-cdn.com/content/image/1-s2.0-S0898122115000346-gr1.jpg "Spatial discretization with the D3Q27 scheme")
exemplarily shows the corresponding directions of the D3Q27 model,
with the D3Q15 and D3Q19 being subsets of the D3Q27.

Since for quasi-incompressible flow, a decoupling of the energy
equation from the Navier-Stokes equation is obtained, the LBGK
equation cannot be used to solve for the temperature. Therefore, a
multi-distribution function (MDF) approach is used to solve a passive
scalar equation for the temperature. This means, it is solved for an
additional set of PPDFs via the TLBGK equation

\begin{equation}
  g_i\left(\mathbf{x}+\mathbf{\Xi}_i\delta t,t+\delta t\right)  =  g_i\left(\mathbf{x},t\right) + \omega_T\delta  t\cdot\left(g_i^{eq}\left(\mathbf{x},t\right)-g_i\left(\mathbf{x},t\right)\right),
\end{equation}

where $\omega_T$ is a function of the _Prandtl_ number and
$g_i^{eq}=T\cdot\chi$ is the equilibrium distribution function for the
temperature.

The no-slip boundary condition employs the interpolated bounce-back
formulation by [Bouzidi et al.][Bouzidi2001], which is
second-order accurate. The wall temperature is set equal to body
temperature $T_w=309.15$K. At the nostrils and at the pharynx the
combined pressure and Saint-Vernant/Wanzel boundary condition
presented in [Lintermann et al. 2014][LintermannSchlimpertEtAl14]
is used, i.e., the
pressure at the pharynx is continuously reduced until a target _Reynolds_ number
is reached at the pharynx, and the density
and velocity at the nostrils are recalculated by an extrapolation of
the momentum from the next inner cell layer using the LBM-reformulated
equation of Saint-Vernant/Wanzel. The temperature at the 
nostrils is set to $T_n=293.15$K. 






[jsc-link]: http://www.fz-juelich.de/ias/jsc/EN/Home/home_node.html "JÃ¼lich Supercomputing Centre"

[kumc-link]: http://www.kumc.or.kr/language/ENG/main/index.do "Korea University Medical Center"

[jupyterhub]: https://jupyter.org/hub "Jupyter Hub"

[tensorflow]: https://www.tensorflow.org "Tensorflow"

[csfwiki]: https://en.wikipedia.org/wiki/Cerebrospinal_fluid "Cerebrospinal Fluids"

[saswiki]: https://en.wikipedia.org/wiki/Meninges "Subarachnoid Spaces"

[Ambarki2012]: http://www.ajnr.org/content/33/10/1951.long "Evaluation of Automatic Measurement of the Intracranial Volume Based on Quantitative MR Imaging"

[Armonda1994]: https://academic.oup.com/neurosurgery/article/35/2/214/2757389 "Quantitative Cine-Mode Magnetic Resonance Imaging of Chiari I Malformations: An Analysis of Cerebrospinal Fluid Dynamics"

[Baledent2004]: https://www.researchgate.net/publication/8937318_Relationship_Between_Cerebrospinal_Fluid_and_Blood_Dynamics_in_Healthy_Volunteers_and_Patients_with_Communicating_Hydrocephalus "Relationship between Cerebrospinal Fluid and Blood Dynamics in Healthy Volunteers and Patients with Communicating Hydrocephalus"

[Bhatnagar1954]: https://journals.aps.org/pr/abstract/10.1103/PhysRev.94.511 "A Model for Collision Processes in Gases. I. Small Amplitude Processes in Charged and Neutral One-Component Systems"

[Bouzidi2001]: https://aip.scitation.org/doi/10.1063/1.1399290 "Momentum Transfer of a Boltzmann-Lattice Fluid with Boundaries"

[Czosnyka2011]: https://link.springer.com/chapter/10.1007/978-1-4419-9997-9_7 "Dynamics of Cerebrospinal Fluid: From Theoretical Models to Clinical Applications"

[Folk2010]: "Balancing Performance and Preservation Lessons Learned with HDF5"

[FreitasSchroeder08]: https://www.sciencedirect.com/science/article/pii/S0021929008002546 "Numerical Investigation of the Three-Dimensional Flow in a Human Lung Model"

[Hanel2004]: https://www.springer.com/de/book/9783540442479 "Molekulare Gasdynamik, Einf&uuml;hrung in die kinetische Theorie der Gase und Lattice-Boltzmann-Methoden"

[Gupta2010]: https://royalsocietypublishing.org/doi/full/10.1098/rsif.2010.0033?url_ver=Z39.88-2003&rfr_id=ori:rid:crossref.org&rfr_dat=cr_pub%3dpubmed "Cerebrospinal Fluid Dynamics in the Human Cranial Subarachnoid Space: an Overlooked Mediator of Cerebral Disease. I. Computational Model"

[Khani2018]: https://biomechanical.asmedigitalcollection.asme.org/article.aspx?articleID=2683234 "Anthropomorphic Model of Intrathecal Cerebrospinal Fluid Dynamics within the Spinal Subarachnoid Space: Spinal Cord Nerve Roots Increase Steady-Streaming"

[Kraus2014]: https://ieeexplore.ieee.org/abstract/document/7081677 "Accelerating a C++ CFD Code with OpenACC"

[Kuwata2015]: https://www.sciencedirect.com/science/article/pii/S0021999114006767 "Anomaly of the Lattice Boltzmann Methods in Three-Dimensional Cylindrical Flows"

[Linninger2016]: https://www.annualreviews.org/doi/full/10.1146/annurev-fluid-122414-034321 "Cerebrospinal Fluid Mechanics and Its Coupling to Cerebrovascular Dynamics"

[LintermannSchlimpertEtAl14]: https://www.sciencedirect.com/science/article/pii/S0045782514001340 "Massively Parallel Grid Generation on HPC Systems"

[Lintermann2016]: https://www.researchgate.net/publication/303843584_Efficient_Parallel_Geometry_Distribution_for_the_Simulation_of_Complex_Flows "Efficient Parallel Geometry Distribution for the Simulation of Complex Flows"

[Lintermann2017a]: https://www.sciencedirect.com/science/article/pii/S0997754616301236 "Simulation of Aerosol Particle Deposition in the Upper Human Tracheobronchial Tract"

[LiZingaleEtAl03]: https://ieeexplore.ieee.org/document/1592942 "Parallel netCDF: A High-Performance Scientific I/O Interface"

[Nicolini2016]: https://www.researchgate.net/publication/308901613_Software_Cost_Analysis_of_GPU-Accelerated_Aeroacoustics_Simulations_in_C_with_OpenACC "Software Cost Analysis of GPU-Accelerated Aeroacoustics Simulations in C++ with OpenACC"

[Qian1992]: https://iopscience.iop.org/article/10.1209/0295-5075/17/6/001/meta "Lattice BGK Models for Navier-Stokes Equation"

[Sagan94]: https://www.springer.com/de/book/9780387942650 "Space-Filtering Curves"

[Saele2015]: https://www.sciencedirect.com/science/article/pii/S0022510X15000684?via%3Dihub "Association between Ventricular Volume Measures and Pulsatile and Static Intracranial Pressure Scores in Non-Communicating Hydrocephalus"

[Stadlbauer2010]: https://www.sciencedirect.com/science/article/pii/S1053811910001588 "Insight into the Patterns of Cerebrospinal Fluid Flow in the Human Ventricular System Using MR Velocity Mapping"

[Tangen2015]: https://www.sciencedirect.com/science/article/pii/S0021929015000974 "CNS Wide Simulation of Flow Resistance and Drug Transport due to Spinal Microanatomy"

[White2011]: https://www.sciencedirect.com/science/article/pii/S0021999111002798 "Rotational Invariance in the Three-Dimensional Lattice Boltzmann Method is Dependent on the Choice of Lattice"

